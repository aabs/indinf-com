---
layout: post
title: Nondeterministic Finite Automaton (NDFA) in C#
date: 2007-01-16 15:37:39.000000000 +11:00
type: post
published: true
status: publish
categories: []
tags:
- C#
- Computer Science
meta: {}
author:
  login: aabs
  email: matthews.andrew@gmail.com
  display_name: Andrew Matthews
  first_name: Andrew
  last_name: Matthews
---

<p>Download the source: <a href="http://aabs.files.wordpress.com/2007/01/ndfa.pdf">Example 1.</a></p>
<p>Sad to say, but my holidays are over, and Iâ€™m back to work. I tried pretty hard to keep my hands away from the laptop while I was off, but I got itchy fingers towards the end so I had a stab at implementing a non-deterministic finite automaton (NDFA). I implemented it to give me an excuse to play with the <a href="http://www.itu.dk/research/c5/">C5 collections library</a>. As it turned out the class was relatively easy to implement as a deterministic finite automaton (DFA) but required a bit more finesse to extend it to the general case of the NDFA. Anyhow I got it working OK. Here's how you might use it: </p>
<div class="csharpcode">
<pre><span class="lnum"></span></pre>
<div class="csharpcode">
<pre><span class="lnum">   1:  </span>NDFA&lt;QState, <span class="kwrd">char</span>, <span class="kwrd">string</span>&gt; ndfa = <span class="kwrd">new</span> NDFA&lt;QState, <span class="kwrd">char</span>, <span class="kwrd">string</span>&gt;();</pre>
<pre><span class="lnum">   2:  </span>ndfa.AllStates.AddAll(<span class="kwrd">new</span> QState[] { QState.err, QState.q0, QState.q1, QState.q2 });</pre>
<pre><span class="lnum">   3:  </span>ndfa.AcceptStates.AddAll(<span class="kwrd">new</span> QState[] { QState.q2});</pre>
<pre><span class="lnum">   4:  </span>ndfa.StartState = QState.q0;</pre>
<pre><span class="lnum">   5:  </span>ndfa.ErrorState = QState.err;</pre>
<pre><span class="lnum">   6:  </span>ndfa.SetStateComparer(<span class="kwrd">new</span> QStateComparer&lt;QState&gt;());</pre>
<pre><span class="lnum">   7:  </span>ndfa.SetErrorHandler(<span class="kwrd">delegate</span> { Debug.WriteLine(<span class="str">"Error State Entered"</span>); });</pre>
<pre><span class="lnum">   8:  </span>&nbsp;</pre>
<pre><span class="lnum">   9:  </span>ndfa.TransitionTable.Add(<span class="kwrd">new</span> Rec&lt;QState, <span class="kwrd">char</span>&gt;(QState.q0, <span class="str">'a'</span>), QState.q1);</pre>
<pre><span class="lnum">  10:  </span>ndfa.TransitionTable.Add(<span class="kwrd">new</span> Rec&lt;QState, <span class="kwrd">char</span>&gt;(QState.q0, <span class="str">'a'</span>), QState.q2);</pre>
<pre><span class="lnum">  11:  </span>ndfa.TransitionTable.Add(<span class="kwrd">new</span> Rec&lt;QState, <span class="kwrd">char</span>&gt;(QState.q1, <span class="str">'b'</span>), QState.q3);</pre>
<pre><span class="lnum">  12:  </span>ndfa.TransitionTable.Add(<span class="kwrd">new</span> Rec&lt;QState, <span class="kwrd">char</span>&gt;(QState.q2, <span class="str">'b'</span>), QState.q3);</pre>
<pre><span class="lnum">  13:  </span>&nbsp;</pre>
<pre><span class="lnum">  14:  </span>TransitionFunction&lt;QState, <span class="kwrd">char</span>, <span class="kwrd">string</span>&gt; func =</pre>
<pre><span class="lnum">  15:  </span>    <span class="kwrd">delegate</span>(INdfa&lt;QState, <span class="kwrd">char</span>, <span class="kwrd">string</span>&gt; idfa, QState q, QState qn, <span class="kwrd">char</span> i)</pre>
<pre><span class="lnum">  16:  </span>    {</pre>
<pre><span class="lnum">  17:  </span>        <span class="kwrd">if</span> (idfa.IsErrorState)</pre>
<pre><span class="lnum">  18:  </span>            <span class="kwrd">return</span> <span class="str">"Error Occurred."</span>;</pre>
<pre><span class="lnum">  19:  </span>        <span class="kwrd">return</span></pre>
<pre><span class="lnum">  20:  </span>            <span class="kwrd">string</span>.Format(<span class="str">"Transitioned from {0} to {1} because of input '{2}' ({3})"</span>, q,</pre>
<pre><span class="lnum">  21:  </span>                          qn, i, idfa.IsInAcceptState ? <span class="str">"Accept State"</span> : <span class="str">"Non-Accept State"</span>);</pre>
<pre><span class="lnum">  22:  </span>    };</pre>
<pre><span class="lnum">  23:  </span>&nbsp;</pre>
<pre><span class="lnum">  24:  </span>ndfa.TransitionFunctions.Add(<span class="kwrd">new</span> Rec&lt;QState, QState&gt;(QState.q0, QState.q1), func);</pre>
<pre><span class="lnum">  25:  </span>ndfa.TransitionFunctions.Add(<span class="kwrd">new</span> Rec&lt;QState, QState&gt;(QState.q0, QState.q2), func);</pre>
<pre><span class="lnum">  26:  </span>ndfa.TransitionFunctions.Add(<span class="kwrd">new</span> Rec&lt;QState, QState&gt;(QState.q1, QState.q3), func);</pre>
<pre><span class="lnum">  27:  </span>ndfa.TransitionFunctions.Add(<span class="kwrd">new</span> Rec&lt;QState, QState&gt;(QState.q2, QState.q3), func);</pre>
<pre><span class="lnum">  28:  </span>&nbsp;</pre>
<pre><span class="lnum">  29:  </span><span class="kwrd">foreach</span> (<span class="kwrd">string</span> output <span class="kwrd">in</span> ndfa.ProcessInput(<span class="str">"ab"</span>.ToCharArray()))</pre>
<pre><span class="lnum">  30:  </span>{</pre>
<pre><span class="lnum">  31:  </span>    Debug.WriteLine(output);</pre>
<pre><span class="lnum">  32:  </span>}</pre>
</div>
</div>
<p>Example 1: Using the NDFA</p>
<p>This sample implements a simple state machine that diverges into two states and then converges back into a single accepting state:</p>
<p><img src="{{ site.baseurl }}/assets/358981593_c4c694cc70_o_d.png" /> </p>
<p>being a generic class it can work as well with chars, ints or enums for the state. My example above uses a simple enum called QState, plus a comparator to allow states to be stored in an ordered tree collection to allow quick state transitions:</p>
<div class="csharpcode">
<pre><span class="lnum">   1:  </span><span class="kwrd">public</span> <span class="kwrd">enum</span> QState : <span class="kwrd">int</span></pre>
</div>
<div class="csharpcode">
<pre><span class="lnum">   2:  </span>{</pre>
</div>
<div class="csharpcode">
<pre><span class="lnum">   3:  </span>    err,</pre>
</div>
<div class="csharpcode">
<pre><span class="lnum">   4:  </span>    q0,</pre>
</div>
<div class="csharpcode">
<pre><span class="lnum">   5:  </span>    q1,</pre>
</div>
<div class="csharpcode">
<pre><span class="lnum">   6:  </span>    q2,</pre>
</div>
<div class="csharpcode">
<pre><span class="lnum">   7:  </span>    q3</pre>
</div>
<div class="csharpcode">
<pre><span class="lnum">   8:  </span>}</pre>
</div>
<div class="csharpcode">
<pre><span class="lnum">   9:  </span>&nbsp;</pre>
</div>
<div class="csharpcode">Example 2. The states used by the NDFA</div>
<div class="csharpcode">&nbsp;</div>
<div class="csharpcode">The Rec&lt;A,B&gt; class is a record class (tuple) that is defined in C5 for associative containers such as dictionaries. I based my comparer on Rec&lt;Q,Q&gt; because I needed it to order the transition table which stores the one to many mappings from state to state.</div>
<div class="csharpcode">&nbsp;</div>
<div class="csharpcode">
<pre><span class="lnum">  10:  </span><span class="kwrd">public</span> <span class="kwrd">class</span> QStateComparer&lt;Q&gt; : IComparer&lt;Rec&lt;Q, Q&gt;&gt;</pre>
</div>
<div class="csharpcode">
<pre><span class="lnum">  11:  </span>{</pre>
</div>
<div class="csharpcode">
<pre><span class="lnum">  12:  </span>    <span class="kwrd">public</span> <span class="kwrd">int</span> Compare(Rec&lt;Q, Q&gt; x, Rec&lt;Q, Q&gt; y)</pre>
</div>
<div class="csharpcode">
<pre><span class="lnum">  13:  </span>    {</pre>
</div>
<div class="csharpcode">
<pre><span class="lnum">  14:  </span>        <span class="kwrd">int</span> a = (13 * Convert.ToInt32(x.X1)) + Convert.ToInt32(x.X2);</pre>
</div>
<div class="csharpcode">
<pre><span class="lnum">  15:  </span>        <span class="kwrd">int</span> b = (13 * Convert.ToInt32(y.X1)) + Convert.ToInt32(y.X2);</pre>
</div>
<div class="csharpcode">
<pre><span class="lnum">  16:  </span>        <span class="kwrd">return</span> a - b;</pre>
</div>
<div class="csharpcode">
<pre><span class="lnum">  17:  </span>    }</pre>
</div>
<div class="csharpcode">
<pre><span class="lnum">  18:  </span>}</pre>
</div>
<p>Example 3. A comparer to allow QState to be used with the C5 TreeSet, HashBag and HashDictionary collections.</p></p>
<p>In example 1, line 14, I use an anonymous delegate to create a <em>'transition function'</em>. Sorry to use contradictory terminology - transition function is a term used to describe the function that is used to find the next state to be transitioned to. In my case though I have augmented the NDFA to allow a delegate to be invoked as each transition is made. This allows the NDFA to do useful work as it goes. In the case of the function on line 14, it just says what happened to cause the transition, without doing anything.</p>
